syntax = "proto3";

package bidderapi.v1;

import "protoc-gen-openapiv2/options/annotations.proto";
import "google/api/annotations.proto";
import "buf/validate/validate.proto";
import "google/protobuf/wrappers.proto";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "Bidder API";
    version: "1.0.0-alpha";
    license: {
      name: "Business Source License 1.1";
      url: "https://github.com/primev/mev-commit/blob/main/LICENSE";
    };
  };
};

service Bidder {
  // SendBid
  //
  // Send a bid to the bidder mev-commit node.
  rpc SendBid(Bid) returns (stream Commitment) {
    option (google.api.http) = {
      post: "/v1/bidder/bid"
      body: "*"
    };
  }

  // Deposit
  //
  // Deposit is called by the bidder node to add deposit in the bidder registry.
  rpc Deposit(DepositRequest) returns (DepositResponse) {
    option (google.api.http) = {post: "/v1/bidder/deposit/{amount}"};
  }

  // AutoDeposit
  //
  // AutoDeposit is called by the bidder node to add deposit in the bidder registry and move funds automatily from one window to another.
  rpc AutoDeposit(DepositRequest) returns (AutoDepositResponse) {
    option (google.api.http) = {post: "/v1/bidder/auto_deposit/{amount}"};
  }

  // CancelAutoDeposit
  //
  // CancelAutoDeposit is called by the bidder node to cancel the auto deposit.
  rpc CancelAutoDeposit(CancelAutoDepositRequest) returns (CancelAutoDepositResponse) {
    option (google.api.http) = {post: "/v1/bidder/cancel_auto_deposit"};
  }

  // AutoDepositStatus
  //
  // AutoDepositStatus is called by the bidder node to get the status of the auto deposit.
  rpc AutoDepositStatus(EmptyMessage) returns (AutoDepositStatusResponse) {
    option (google.api.http) = {get: "/v1/bidder/auto_deposit_status"};
  }

  // WithdrawFromWindows
  //
  // WithdrawFromWindows is called by the bidder node to withdraw funds from multiple windows.
  rpc WithdrawFromWindows(WithdrawFromWindowsRequest) returns (WithdrawFromWindowsResponse) {
    option (google.api.http) = {post: "/v1/bidder/withdraw_from_windows"};
  }

  // GetDeposit
  //
  // GetDeposit is called by the bidder to get its deposit in the bidder registry.
  rpc GetDeposit(GetDepositRequest) returns (DepositResponse) {
    option (google.api.http) = {
      get: "/v1/bidder/get_deposit"
    };
  }
  // Withdraw
  //
  // Withdraw is called by the bidder to withdraw deposit from the bidder registry.
  rpc Withdraw(WithdrawRequest) returns (WithdrawResponse) {
    option (google.api.http) = {post: "/v1/bidder/withdraw"};
  }
}

message DepositRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Deposit request"
      description: "Deposit for bids to be issued by the bidder in wei."
      required: ["amount"]
    }
    example: "{\"amount\": \"1000000000000000000\", \"window_number\": 1 }"
  };
  string amount = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Amount of ETH to be deposited in wei."
    pattern: "[0-9]+"
  }, (buf.validate.field).cel = {
      id: "amount",
      message: "amount must be a valid integer.",
      expression: "this.matches('^[1-9][0-9]*$')"
  }];
  google.protobuf.UInt64Value window_number = 2 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Optional window number for querying deposit. If not specified, the current block number is used."
    }, (buf.validate.field).cel = {
      id: "window_number",
      message: "window_number must be a positive integer if specified.",
      expression: "this == null || (this > 0)"
    }];
  google.protobuf.UInt64Value block_number = 3 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Optional block number for querying deposit. If specified, calculate window based on this block number."
    }, (buf.validate.field).cel = {
      id: "block_number",
      message: "block_number must be a positive integer if specified.",
      expression: "this == null || (this > 0)"
    }];
};

message DepositResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Deposit response"
      description: "Get deposit for bidder in the bidder registry."
    }
    example: "{\"amount\": \"1000000000000000000\", \"window_number\": 1}"
  };
  string amount = 1;
  google.protobuf.UInt64Value window_number = 2;
};

message AutoDepositResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "AutoDeposit response"
      description: "Response on AutoDeposit request."
    }
    example: "{\"start_block_number\": \"1\", \"amount_per_window\": \"1000000000000000000\"}"
  };
  google.protobuf.UInt64Value start_block_number = 1;
  string amount_per_window = 2;
};

message AutoDepositStatusResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "AutoDeposit status response"
      description: "AutoDeposit status from the bidder registry."
    }
    example: "{\"window_balances\": [{\"amount\": \"1000000000000000000\", \"window_number\": 1}, {\"amount\": \"1000000000000000000\", \"window_number\": 2}, {\"amount\": \"1000000000000000000\", \"window_number\": 3}], \"isWorking\": true}"
  };
  repeated AutoDeposit window_balances = 1;
  bool is_working = 2;
};

message CancelAutoDepositRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "CancelAutoDeposit request"
      description: "Request to cancel AutoDeposit."
    }
  };
  bool withdraw = 1;
};

message CancelAutoDepositResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "CancelAutoDeposit response"
      description: "CancelAutoDeposit deposit from the bidder registry."
    }
    example: "{\"window_numbers\": [1, 2, 3]}"
  };
  repeated google.protobuf.UInt64Value window_numbers = 1;
};

message AutoDeposit {
  string amount = 1;
  google.protobuf.UInt64Value window_number = 2;
}
message EmptyMessage {};

message GetDepositRequest {
  google.protobuf.UInt64Value window_number = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Optional window number for querying deposits. If not specified, the current block number is used."
    }, (buf.validate.field).cel = {
      id: "window_number",
      message: "window_number must be a positive integer if specified.",
      expression: "this == null || (this > 0)"
    }];
}

message WithdrawRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Withdraw request"
      description: "Withdraw deposit from the bidder registry."
    }
    example: "{\"window_number\": 1 }"
  };
  google.protobuf.UInt64Value window_number = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Optional window number for withdrawing deposits. If not specified, the last window number is used."
    }, (buf.validate.field).cel = {
      id: "window_number",
      message: "window_number must be a positive integer if specified.",
      expression: "this == null || (this > 0)"
    }];
};

message WithdrawResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Withdraw response"
      description: "Withdraw deposit from the bidder registry."
    }
    example: "{\"amount\": \"1000000000000000000\", \"window_number\": 1 }"
  };
  string amount = 1;
  google.protobuf.UInt64Value window_number = 2;
};

message WithdrawFromWindowsRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Withdraw from multiple windows request"
      description: "Withdraw deposit from the bidder registry."
      required: ["window_numbers"]
    }
    example: "{\"window_numbers\": [1, 2, 3]}"
  };
  repeated google.protobuf.UInt64Value window_numbers = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Window numbers for withdrawing deposits."
    }, (buf.validate.field).cel = {
      id: "window_numbers",
      message: "window_numbers must be a valid array of positive integers.",
      expression: "this.all(r, r > 0) && size(this) > 0"
    }];
};

message WithdrawFromWindowsResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Withdraw from multiple windows response"
      description: "Withdraw deposit from the bidder registry."
    }
    example: "{\"withdraw_responses\": [{\"amount\": \"1000000000000000000\", \"window_number\": 1 }, {\"amount\": \"1000000000000000000\", \"window_number\": 2 }, {\"amount\": \"1000000000000000000\", \"window_number\": 3 } ]}"
  };
  repeated WithdrawResponse withdraw_responses = 1;
};

message Bid {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Bid message"
      description: "Unsigned bid message from bidders to the bidder mev-commit node."
      required: ["tx_hashes", "amount", "block_number"]
    }
    example: "{\"tx_hashes\": [\"fe4cb47db3630551beedfbd02a71ecc69fd59758e2ba699606e2d5c74284ffa7\", \"71c1348f2d7ff7e814f9c3617983703435ea7446de420aeac488bf1de35737e8\"], \"amount\": \"1000000000000000000\", \"block_number\": 123456}"
  };
  repeated string tx_hashes = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Hex string encoding of the hashes of the transactions that the bidder wants to include in the block."
    pattern: "[a-fA-F0-9]{64}"
  }, (buf.validate.field).cel = {
        id: "tx_hashes",
        message: "tx_hashes must be a valid array of transaction hashes.",
        expression: "this.all(r, r.matches('^[a-fA-F0-9]{64}$')) && size(this) > 0"
  }];
  string amount = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Amount of ETH that the bidder is willing to pay to the provider for including the transaction in the block."
    pattern: "[0-9]+"
  }, (buf.validate.field).cel = {
      id: "amount",
      message: "amount must be a valid integer.",
      expression: "this.matches('^[0-9]+$') && uint(this) > 0"
  }];
  int64 block_number = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Max block number that the bidder wants to include the transaction in."
  }, (buf.validate.field).cel = {
      id: "block_number",
      message: "block_number must be a valid integer.",
      expression: "uint(this) > 0"
  }];
  int64 decay_start_timestamp = 4 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Timestamp at which the bid starts decaying."
  }, (buf.validate.field).cel = {
      id: "decay_start_timestamp",
      message: "decay_start_timestamp must be a valid integer.",
      expression: "uint(this) > 0"
  }];
  int64 decay_end_timestamp = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Timestamp at which the bid ends decaying."
  }, (buf.validate.field).cel = {
      id: "decay_end_timestamp",
      message: "decay_end_timestamp must be a valid integer.",
      expression: "uint(this) > 0"
  }];
};

message Commitment {
  repeated string tx_hashes = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Hex string encoding of the hash of the transaction that the bidder wants to include in the block."
    pattern: "[a-fA-F0-9]{64}"
  }];
  string bid_amount = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Amount of ETH that the bidder has agreed to pay to the provider for including the transaction in the block."
  }];
  int64 block_number = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Max block number that the bidder wants to include the transaction in."
  }];
  string received_bid_digest = 4 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Hex string encoding of digest of the bid message signed by the bidder."
  }];
  string received_bid_signature = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Hex string encoding of signature of the bidder that sent this bid."
  }];
  string commitment_digest = 6 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Hex string encoding of digest of the commitment."
  }];
  string commitment_signature = 7 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Hex string encoding of signature of the commitment signed by the provider confirming this transaction."
  }];
  string provider_address = 8 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Hex string encoding of the address of the provider that signed the commitment signature."
  }];
  int64 decay_start_timestamp = 9 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Timestamp at which the bid starts decaying."
  }];
  int64 decay_end_timestamp = 10 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Timestamp at which the bid ends decaying."
  }];
  int64 dispatch_timestamp = 11 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Timestamp at which the commitment is published."
  }];
};
