package sim_test

import (
	"context"
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"

	"github.com/primev/mev-commit/tools/preconf-rpc/sim"
)

var jsonRPCResponse1 = []byte(`[{"baseFeePerGas":"0x2d04732e","blobGasUsed":"0x0","calls":[{"gasUsed":"0x5208","logs":[],"returnData":"0x","status":"0x1"}],"difficulty":"0x0","excessBlobGas":"0x100000","extraData":"0x726574682f76312e382e322f6c696e7578","gasLimit":"0x2aea540","gasUsed":"0x5208","hash":"0xaf51a6fb4ea22f5175baeaeac9fb15c55bf96f5a42974fec5cdc0e9b5e41e7a0","logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","miner":"0x1f9090aae28b8a3dceadf281b0f12828e676c326","mixHash":"0x8f829a3c6bfe34dc0224d2b4bf80190fdabc184c5f56f70a5d462f4696f1309c","nonce":"0x0000000000000000","number":"0x168d7c9","parentBeaconBlockRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","parentHash":"0x63eea0ad2621b94f49340c8b7ef7ead45967083894af3aab1ff7b67d9dbd7df7","receiptsRoot":"0xf78dfb743fbd92ade140711c8bbc542b5e307f0ab7984eff35d751969fe57efa","requestsHash":"0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","size":"0x2af","stateRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","timestamp":"0x68fb9a4b","transactions":["0xe0310102ffb7651c28cb3114f1e9137f6b6fd9ccf8326ba9657c333b0cb0ad1a"],"transactionsRoot":"0x8ae72c26cb403244bb8de6039212a55eb00bb7372c2459b0967df5c5e97a526c","uncles":[],"withdrawals":[],"withdrawalsRoot":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"}]`)

var jsonRPCResponse2 = []byte(`[{"baseFeePerGas":"0x2d04732e","blobGasUsed":"0x0","calls":[{"gasUsed":"0x5208","logs":[{"address":"0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee","blockHash":null,"blockNumber":"0x168d7c9","blockTimestamp":"0x68fb9a4b","data":"0x0000000000000000000000000000000000000000000000000000000000000007","logIndex":"0x0","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x000000000000000000000000ae2885e0e7a6c5f99b93b4dbc43d206c7cf67c7e","0x000000000000000000000000ae2885e0e7a6c5f99b93b4dbc43d206c7cf67c7e"],"transactionHash":"0xe0310102ffb7651c28cb3114f1e9137f6b6fd9ccf8326ba9657c333b0cb0ad1a","transactionIndex":"0x0"}],"returnData":"0x","status":"0x1"}],"difficulty":"0x0","excessBlobGas":"0x100000","extraData":"0x726574682f76312e382e322f6c696e7578","gasLimit":"0x2aea540","gasUsed":"0x5208","hash":"0x0b99997c087f1ffd50628a2a4e3e147c0c728a5bffdb1bb2d069f1e4254ba1d3","logsBloom":"0x00000000000000001000000000000000001000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000040000000000000000000000000000000000000000000000000000000000000000002000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","miner":"0x1f9090aae28b8a3dceadf281b0f12828e676c326","mixHash":"0x71b40dd1254adf5a9834608fc6e73325eb1ddacff14ee2b3d6bfd031b678c30e","nonce":"0x0000000000000000","number":"0x168d7c9","parentBeaconBlockRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","parentHash":"0x63eea0ad2621b94f49340c8b7ef7ead45967083894af3aab1ff7b67d9dbd7df7","receiptsRoot":"0x7df755b885cf2890db03b44cacb889bda231ba87a572a4cec66a06bdaff31f5d","requestsHash":"0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","size":"0x2af","stateRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","timestamp":"0x68fb9a4b","transactions":["0xe0310102ffb7651c28cb3114f1e9137f6b6fd9ccf8326ba9657c333b0cb0ad1a"],"transactionsRoot":"0x8ae72c26cb403244bb8de6039212a55eb00bb7372c2459b0967df5c5e97a526c","uncles":[],"withdrawals":[],"withdrawalsRoot":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"}]`)

var jsonRPCResponse3 = []byte(`{"result":[{"baseFeePerGas":"0xbf01a7a","blobGasUsed":"0x0","calls":[{"gasUsed":"0x2ed5c","logs":[{"address":"0x8290333cef9e6d528dd5618fb97a76f268f3edd4","blockHash":null,"blockNumber":"0x16ebc3f","blockTimestamp":"0x694301db","data":"0x000000000000000000000000000000000000000000000026b913053a78b42b09","logIndex":"0x0","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000000c8aa570a1dfeee5258f3c13e2e967da24bbb505","0x00000000000000000000000074de5d4fcbf63e00296fd95d33236b9794016631"],"transactionHash":"0xf0b4618bfe4e29cefe7bfd821081b53d4c31cb9ed42ccf5dda1e7f39a9ff87f9","transactionIndex":"0x0"}],"returnData":"0x","status":"0x1"}],"traceErrors":[]}]}`)

var jsonRPCResponse4 = []byte(`{"result":[{"baseFeePerGas":"0x55073ed1","blobGasUsed":"0x0","calls":[{"gasUsed":"0x7bbc1","logs":[{"address":"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2","blockHash":null,"blockNumber":"0x16ad602","blockTimestamp":"0x694238df","data":"0x00000000000000000000000000000000000000000000000000038d7ea4c68000","logIndex":"0x0","removed":false,"topics":["0xe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x000000000000000000000000ffffffffffffffff","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000000005af3107a4000","logIndex":"0x1","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x00000000000000000000000021b8065d10f73ee2e260e5b47d3344d3ced7596e"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x66a0f676479cee1d7373f3dc2e2952778bff5bd6","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000018d0d2e3fb783c44","logIndex":"0x2","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000021b8065d10f73ee2e260e5b47d3344d3ced7596e","0x000000000000000000000000930e607c92cfa7bca06d9143ad652c78a7885f7e"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x21b8065d10f73ee2e260e5b47d3344d3ced7596e","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x000000000000000000000000000000000000000001ab120fa7b547f9c396a10000000000000000000000000000000000000000000000061883fe6f32cd209479","logIndex":"0x3","removed":false,"topics":["0x1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x21b8065d10f73ee2e260e5b47d3344d3ced7596e","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005af3107a400000000000000000000000000000000000000000000000000018d0d2e3fb783c440000000000000000000000000000000000000000000000000000000000000000","logIndex":"0x4","removed":false,"topics":["0xd78ad95fa46c994b6551d0da85fc275fe613ce37657fb8d5e3d130840159d822","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x000000000000000000000000930e607c92cfa7bca06d9143ad652c78a7885f7e"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xdac17f958d2ee523a2206206994597c13d831ec7","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x000000000000000000000000000000000000000000000000000000000004563e","logIndex":"0x5","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x000000000000000000000000930e607c92cfa7bca06d9143ad652c78a7885f7e","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x930e607c92cfa7bca06d9143ad652c78a7885f7e","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x0000000000000000000000000000000000000000000000100219f632a46878dd0000000000000000000000000000000000000000000000000000000002ca018a","logIndex":"0x6","removed":false,"topics":["0x1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x930e607c92cfa7bca06d9143ad652c78a7885f7e","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000018d0d2e3fb783c4400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004563e","logIndex":"0x7","removed":false,"topics":["0xd78ad95fa46c994b6551d0da85fc275fe613ce37657fb8d5e3d130840159d822","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000000000000000ef51a","logIndex":"0x8","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x000000000000000000000000e0554a476a092703abdb3ef35c80e0d76d32939f","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000000013e52b9abe000","logIndex":"0x9","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x000000000000000000000000e0554a476a092703abdb3ef35c80e0d76d32939f"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xe0554a476a092703abdb3ef35c80e0d76d32939f","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffff10ae600000000000000000000000000000000000000000000000000013e52b9abe00000000000000000000000000000000000000049cedc7c2b99962861828f84eaae00000000000000000000000000000000000000000000000001a5b603cde46dc3000000000000000000000000000000000000000000000000000000000003014e","logIndex":"0xa","removed":false,"topics":["0xc42079f94a6350d7e6235f29174924f928cc2ac818eb64fed8004e115fbcca67","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000000000000000ef51a","logIndex":"0xb","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x000000000004444c5dc75cb358380d2e3de08a90","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffff10ae600000000000000000000000000000000000000000000000000000000000ef63400000000000000000000000000000000000000010009c72ba83316afcda24277000000000000000000000000000000000000000000000000004a53c150335d470000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a","logIndex":"0xc","removed":false,"topics":["0x40e9cecb9f5f1f1c5b9c97dec2917b7ee92e57ba5563708daca94dd84ad7112f","0x8aa4e11cbdf30eedc92100f4c8a31ff748e201d44712cc8c90d189edaa8e4e47","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xdac17f958d2ee523a2206206994597c13d831ec7","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000000000000000ef634","logIndex":"0xd","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x2260fac5e5542a773aa44fbcfedf7c193bc2c599","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x000000000000000000000000000000000000000000000000000000000000070b","logIndex":"0xe","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000004585fe77225b41b697c938b018e2ac67ac5a20c0","0x0000000000000000000000000de0fa91b6dbab8c8503aaa2d1dfa91a192cb149"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x0000000000000000000000000000000000000000000000000001f438daa06000","logIndex":"0xf","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x0000000000000000000000004585fe77225b41b697c938b018e2ac67ac5a20c0"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x4585fe77225b41b697c938b018e2ac67ac5a20c0","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8f50000000000000000000000000000000000000000000000000001f438daa060000000000000000000000000000000000000086c9ebb824a4e6740ee99b698a301000000000000000000000000000000000000000000000000016b172b73df7c0a00000000000000000000000000000000000000000000000000000000000408fa","logIndex":"0x10","removed":false,"topics":["0xc42079f94a6350d7e6235f29174924f928cc2ac818eb64fed8004e115fbcca67","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x0000000000000000000000000de0fa91b6dbab8c8503aaa2d1dfa91a192cb149"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x2260fac5e5542a773aa44fbcfedf7c193bc2c599","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x0000000000000000000000000000000000000000000000000000000000000000","logIndex":"0x11","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x0000000000000000000000000de0fa91b6dbab8c8503aaa2d1dfa91a192cb149"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xdac17f958d2ee523a2206206994597c13d831ec7","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x000000000000000000000000000000000000000000000000000000000017d8f2","logIndex":"0x12","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000000de0fa91b6dbab8c8503aaa2d1dfa91a192cb149","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x0de0fa91b6dbab8c8503aaa2d1dfa91a192cb149","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x0000000000000000000000000000000000000000000000000000000000035004000000000000000000000000000000000000000000000000000000000b281893","logIndex":"0x13","removed":false,"topics":["0x1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0x0de0fa91b6dbab8c8503aaa2d1dfa91a192cb149","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x000000000000000000000000000000000000000000000000000000000000070b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017d8f2","logIndex":"0x14","removed":false,"topics":["0xd78ad95fa46c994b6551d0da85fc275fe613ce37657fb8d5e3d130840159d822","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xdac17f958d2ee523a2206206994597c13d831ec7","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x0000000000000000000000000000000000000000000000000000000000001b9d","logIndex":"0x15","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x000000000000000000000000000000fee13a103a10d593b9ae06b3e05f2e7e1c"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"},{"address":"0xdac17f958d2ee523a2206206994597c13d831ec7","blockHash":null,"blockNumber":"0x16ed602","blockTimestamp":"0x694438df","data":"0x00000000000000000000000000000000000000000000000000000000002b09c7","logIndex":"0x16","removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af","0x000000000000000000000000fed3c0423fe5711e6d5394356d26eb789cd21732"],"transactionHash":"0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909","transactionIndex":"0x0"}],"returnData":"0x","status":"0x1"}],"difficulty":"0x0","excessBlobGas":"0x8f1c7bc","extraData":"0x726574682f76312e392e332f6c696e7578","gasLimit":"0x392a220","gasUsed":"0x7bbc1","hash":"0x30b868ecb8b61153755d6f1eae08fe172df38a1f04294e65cc2e022a44d4c4b2","logsBloom":"0x0020000800000000200000008000000001000100040000000000000000000000000000002008000000100000000001000a0004000c0020000000000000000000000000000000000c080002080040002000088000040000200000000480000000000802000000022000000000104000000200000000200040000000100008000200200008000000000000008000200800000000010100000a0020004000100000010008000000200000000080100002800006000400000000000000000000200000000802000000080000004000000000000408400000001000000000000000000000200000000000004000000000000001200000000000c01000200000000000","miner":"0xdadb0d80178819f2319190d340ce9a924f783711","mixHash":"0x645f2435915342a9ba1ea246dc8db6e8a1e7a27f1a717f4086447c618ae06d12","nonce":"0x0000000000000000","number":"0x16ed602","parentBeaconBlockRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","parentHash":"0x169b677e8fd5199bfbdfd7f5f29ebda9afe6691048270a401f493839c362dd7e","receiptsRoot":"0xa0546270f7f2ee3224d2df754b89258bd365752e924f6a82e3915083efca4c12","requestsHash":"0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","size":"0xe6f","stateRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","timestamp":"0x694438df","transactions":["0xc2061ea57b0dc287ed3a74a518bbeba883429714956bde637bd877e1a085d909"],"transactionsRoot":"0xf06672518f0ff180e6db1f010dfa3a114395d3ad60f4d2398575198cb3735d64","uncles":[],"withdrawals":[],"withdrawalsRoot":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"}],"swapDetected":true,"swapKinds":["uniswap_v2_swap","uniswap_v3_swap","uniswap_v4_swap"],"traceErrors":[]}`)

var errResponse = []byte(`[{"baseFeePerGas":"0xddacfa4","blobGasUsed":"0x0","calls":[{"error":{"code":3,"message":"execution reverted"},"gasUsed":"0x194714","logs":[],"returnData":"0x064a4ec600000000000000000000000000000000000000000000000000000038af10569100000000000000000000000000000000000000000000000000000038ddca493d","status":"0x0"}],"difficulty":"0x0","excessBlobGas":"0x620000","extraData":"0x726574682f76312e382e322f6c696e7578","gasLimit":"0x2adf7c0","gasUsed":"0x194714","hash":"0xcdb8b3f1cda9f148c44e51e9f9400568fb8479120c8b2da0599207cd9b9846b5","logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","miner":"0xdadb0d80178819f2319190d340ce9a924f783711","mixHash":"0x4f51b3d0ea08e01914bb86339aec2c2ab66b382711059331fbc0c2f56e0e7134","nonce":"0x0000000000000000","number":"0x168bac7","parentBeaconBlockRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","parentHash":"0xb54623fcd9d11cb692091209c4feb1988dc2a9aef1c9e54ce7cee4a8332eeba7","receiptsRoot":"0x7b3251ff8a2414ac1cbcc4b091493cffeaecb6530daf2c2012e7269f07a80cab","requestsHash":"0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","size":"0x1b41","stateRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","timestamp":"0x68fa3a5b","transactions":["0x61d03e5e6754f7e13a2d09024a5be07a44bf1b68e5d363275fb75fa45a224918"],"transactionsRoot":"0xa255a72d9dfcb7143b10ec681f5d5804b1aa3f1f12f67715665a9d90fdcb1370","uncles":[],"withdrawals":[],"withdrawalsRoot":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"}]`)

func TestSimulator(t *testing.T) {
	txns := map[string][]byte{
		"1234":      jsonRPCResponse1,
		"5678":      jsonRPCResponse2,
		"swap":      jsonRPCResponse3,
		"swapArray": jsonRPCResponse4,
		"abcd":      errResponse,
	}
	srv := httptest.NewServer(
		http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			switch r.URL.Path {
			case "/rethsim/simulate/raw":
				var req map[string]interface{}
				defer func() { _ = r.Body.Close() }()
				if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
					http.Error(w, "bad request", http.StatusBadRequest)
					return
				}
				rawTx := req["raw"].(string)
				if resp, ok := txns[rawTx]; ok {
					w.Header().Set("Content-Type", "application/json")
					_, _ = w.Write(resp)
					return
				}
				http.Error(w, "transaction not found", http.StatusNotFound)
			default:
				http.NotFound(w, r)
			}
		}),
	)

	defer srv.Close()

	t.Logf("Test server running at %s", srv.URL)
	simulator := sim.NewSimulator(srv.URL)

	t.Run("SuccessfulSimulation1", func(t *testing.T) {
		result, isSwap, err := simulator.Simulate(context.Background(), "1234", sim.Latest)
		if err != nil {
			t.Fatalf("expected no error, got %v", err)
		}
		if len(result) != 0 {
			t.Fatalf("expected non-empty result")
		}
		if isSwap {
			t.Fatalf("expected isSwap to be false")
		}
	})
	t.Run("SuccessfulSimulation2", func(t *testing.T) {
		result, _, err := simulator.Simulate(context.Background(), "5678", sim.Pending)
		if err != nil {
			t.Fatalf("expected no error, got %v", err)
		}
		if len(result) == 0 {
			t.Fatalf("expected non-empty result")
		}
	})
	t.Run("SuccessfulSimulation_SwapWrappedResult", func(t *testing.T) {
		result, _, err := simulator.Simulate(context.Background(), "swap", sim.Latest)
		if err != nil {
			t.Fatalf("expected no error, got %v", err)
		}
		if len(result) == 0 {
			t.Fatalf("expected non-empty logs for swap simulation")
		}
	})
	t.Run("SuccessfulSimulation_SwapArray", func(t *testing.T) {
		result, isSwap, err := simulator.Simulate(context.Background(), "swapArray", sim.Pending)
		if err != nil {
			t.Fatalf("expected no error, got %v", err)
		}
		if len(result) == 0 {
			t.Fatalf("expected non-empty logs for swap simulation")
		}
		if !isSwap {
			t.Fatalf("expected isSwap=true for swapArray tx")
		}
	})
	t.Run("ErrorSimulation", func(t *testing.T) {
		_, _, err := simulator.Simulate(context.Background(), "abcd", sim.Latest)
		if err == nil {
			t.Fatalf("expected error, got none")
		}
		if !strings.Contains(err.Error(), "reverted") {
			t.Fatalf("unexpected error")
		}
	})
}
